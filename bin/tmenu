#!/bin/bash

TEMP_FILE=$(mktemp)


_tmux() {
    tmux -f ~/.dotfiles/tmenu-tmux.conf $@
}

run-fzf() {
    fzf --prompt "TMenu v0.3 > " -i
}

list-sessions() {
    _tmux list-sessions | awk -F ":" '{print $1}'
}

get-unnamed-session-name() {
    echo "unamed-$(list-sessions | wc -l)"
}

new-session() {
    _tmux new-session -c $HOME -s "$1" -d
}

attach-session() {
    _tmux attach-session
}

get-custom-commands() {
    echo "!new-session"
    echo "!quit"
}

get-user-input() {
    echo 0 > $TEMP_FILE  # scratchpad
    get-custom-commands >> $TEMP_FILE
    list-sessions >> $TEMP_FILE

    cat $TEMP_FILE | sort | uniq | run-fzf
}

scratchpad-is-running() {
    list-sessions | grep "^0$" -q
}

create-scratchpad() {
    new-session "0"
}


while true; do
    USER_INPUT=$(get-user-input)

    if [ "$USER_INPUT" == "" ]; then
        continue
    fi

    # scratchpad
    if [ "$USER_INPUT" == "0" ]; then
        scratchpad-is-running || create-scratchpad
    fi

    # quit
    if [ "$USER_INPUT" == "!quit" ]; then
        exit 0
    fi

    # new session
    if [ "$USER_INPUT" == "!new-session" ]; then
        USER_INPUT="$(get-unnamed-session-name)"

        new-session "$USER_INPUT"
    fi

     _tmux attach-session -t "$USER_INPUT"
done
