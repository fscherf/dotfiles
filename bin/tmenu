#!/bin/bash

TEMP_FILE=$(mktemp)


run-fzf() {
    fzf --prompt "TMenu v0.3 > " -i
}

list-sessions() {
    tmux list-sessions | awk -F ":" '{print $1}'
}

get-unnamed-session-name() {
    echo "unamed-$(list-sessions | wc -l)"
}

new-session() {
    tmux new-session -c $HOME -s "$1" -d
}

attach-session() {
    tmux attach-session
}

get-custom-commands() {
    echo "!scratchpad"
    echo "!new-session"
    echo "!quit"
}

get-user-input() {
    echo 0 > $TEMP_FILE  # scratchpad
    get-custom-commands >> $TEMP_FILE
    list-sessions >> $TEMP_FILE

    cat $TEMP_FILE | sort | uniq | run-fzf
}


while true; do
    USER_INPUT=$(get-user-input)

    if [ "$USER_INPUT" == "" ]; then
        continue
    fi

    # quit
    if [ "$USER_INPUT" == "!quit" ]; then
        exit 0
    fi

    # new session
    if [ "$USER_INPUT" == "!new-session" ]; then
        USER_INPUT="$(get-unnamed-session-name)"

        new-session "$USER_INPUT"
    fi

    # expand !scratchpad to session name "0"
    if [ "$USER_INPUT" == "!scratchpad" ]; then
        USER_INPUT=0
    fi

     tmux attach-session -t "$USER_INPUT"
done
